name: ðŸ¤– AI Self-Iteration

on:
  workflow_dispatch:  # Manual trigger
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

jobs:
  ai-improve:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: AI Analysis & Improvement
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat > ai_improve.py << 'EOF'
          import os
          import json
          import subprocess
          from anthropic import Anthropic
          
          client = Anthropic(api_key=os.environ['ANTHROPIC_API_KEY'])
          
          # Read project files
          readme = open('README.md').read()
          bot_code = open('bot/telegram_bot.py').read()
          data = open('data/discount_times.json').read()
          
          # Get git status
          git_status = subprocess.run(['git', 'status', '--short'], capture_output=True, text=True).stdout
          
          prompt = f"""
          You are an AI assistant improving a GitHub project: Japan Supermarket Discount Timer.
          
          Current project state:
          
          README.md:
          {readme}
          
          Bot code:
          {bot_code}
          
          Data:
          {data}
          
          Git status:
          {git_status}
          
          Task: Analyze the project and suggest ONE concrete improvement. Focus on:
          1. Adding new features (reminders, location-based, more supermarkets)
          2. Bug fixes
          3. Code quality
          4. Data improvements
          
          Return JSON only:
          {{
            "improvement": "Brief description",
            "files": [
              {{"path": "file/path", "action": "create|modify", "content": "full file content"}}
            ],
            "commit_message": "feat: ..."
          }}
          """
          
          response = client.messages.create(
              model="claude-sonnet-4-5",
              max_tokens=4000,
              messages=[{"role": "user", "content": prompt}]
          )
          
          result = json.loads(response.content[0].text)
          
          # Apply changes
          branch_name = f"ai-improve-{result['improvement'][:20].replace(' ', '-')}"
          subprocess.run(['git', 'checkout', '-b', branch_name])
          
          for file_change in result['files']:
              os.makedirs(os.path.dirname(file_change['path']), exist_ok=True)
              with open(file_change['path'], 'w') as f:
                  f.write(file_change['content'])
              subprocess.run(['git', 'add', file_change['path']])
          
          subprocess.run(['git', 'commit', '-m', result['commit_message']])
          subprocess.run(['git', 'push', '-u', 'origin', branch_name])
          
          # Create PR
          pr_body = f"""
          ## ðŸ¤– AI-Generated Improvement
          
          {result['improvement']}
          
          ### Changes
          {chr(10).join('- ' + f['path'] for f in result['files'])}
          
          ---
          *This PR was automatically generated by AI iteration workflow*
          """
          
          subprocess.run([
              'gh', 'pr', 'create',
              '--title', result['commit_message'],
              '--body', pr_body,
              '--base', 'main'
          ])
          
          print(f"âœ… Created PR: {result['commit_message']}")
          EOF
          
          pip install anthropic
          python ai_improve.py
